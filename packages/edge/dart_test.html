<!DOCTYPE html>
<html lang="en">
<head>
  <script type="module">
    const workers = await window.navigator.serviceWorker.getRegistrations();
    await Promise.all(workers.map((worker) => worker.unregister()));

    let worker;
    const channel = new MessageChannel();
    await window.navigator.serviceWorker.register('sw.js');
    worker = await window.navigator.serviceWorker.ready;
      
    channel.port1.onmessage = (event) => {
      if (event.data === 'init') {
        window.dartSw = 'ready';
      }
      if (event.data.type === 'fetch') {
        window.__fetchEvent('elliot');
      }
    };
    
    worker.active.postMessage('init', [channel.port2]);
  </script>
  <script src="packages/test/dart.js"></script>
</head>
<body>
  {{testScript}}
</body>
</html>